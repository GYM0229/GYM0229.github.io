<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>学成在线-媒资管理模块 | Lemon的博客</title><meta name="author" content="Lemon"><meta name="copyright" content="Lemon"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="学成在线--融资管理模块">
<meta property="og:type" content="article">
<meta property="og:title" content="学成在线-媒资管理模块">
<meta property="og:url" content="http://example.com/2024/05/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-%E8%9E%8D%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/index.html">
<meta property="og:site_name" content="Lemon的博客">
<meta property="og:description" content="学成在线--融资管理模块">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://images.wallpaperscraft.com/image/single/girl_street_sakura_1156520_1280x720.jpg">
<meta property="article:published_time" content="2024-05-17T08:30:00.000Z">
<meta property="article:modified_time" content="2024-05-19T14:03:13.078Z">
<meta property="article:author" content="Lemon">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images.wallpaperscraft.com/image/single/girl_street_sakura_1156520_1280x720.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/05/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-%E8%9E%8D%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":"ture","top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":"ture","highlightLang":"ture","highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '学成在线-媒资管理模块',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-19 22:03:13'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-categories-card@1.0.0/lib/categorybar.css"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/icon.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-linkhi"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://images.wallpaperscraft.com/image/single/girl_street_sakura_1156520_1280x720.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Lemon的博客"><span class="site-name">Lemon的博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-linkhi"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">学成在线-媒资管理模块</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-17T08:30:00.000Z" title="发表于 2024-05-17 16:30:00">2024-05-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-19T14:03:13.078Z" title="更新于 2024-05-19 22:03:13">2024-05-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">学成在线</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>32分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="学成在线-媒资管理模块"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-模块需求分析"><a href="#1-模块需求分析" class="headerlink" title="1.模块需求分析"></a>1.模块需求分析</h1><h2 id="1-1模块介绍"><a href="#1-1模块介绍" class="headerlink" title="1.1模块介绍"></a>1.1模块介绍</h2><p>媒资管理系统是每个在线教育平台所必须具备的，查阅百度百科对它的定义如下：</p>
<blockquote>
<p>媒体资源管理(Media Asset Management，MAM)系统是建立在多媒体、网络、数据库和数字存储等先进技术基础上的一个对各种媒体及内容(如视/音频资料、文本文件、图表等)进行数字化存储、管理以及应用的总体解决方案，包括数字媒体的采集、编目、管理、传输和编码转换等所有环节。其主要是满足媒体资源拥有者收集、保存、查找、编辑、发布各种信息的要求，为媒体资源的使用者提供访问内容的便捷方法，实现对媒体资源的高效管理，大幅度提高媒体资源的价值。</p>
</blockquote>
<ul>
<li>每个教学机构都可以在媒资系统管理自己的教学资源，包括：视频、教案等文件。</li>
<li><p>目前媒资管理的主要管理对象是视频、图片、文档等，包括：媒资文件的查询、文件上传、视频处理等。</p>
</li>
<li><p>媒资查询：教学机构查询自己所拥有的媒资信息。</p>
</li>
<li>文件上传：包括上传图片、上传文档、上传视频。</li>
<li>视频处理：视频上传成功，系统自动对视频进行编码处理。</li>
<li>文件删除：教学机构删除自己上传的媒资文件。<h2 id="1-2业务流程"><a href="#1-2业务流程" class="headerlink" title="1.2业务流程"></a>1.2业务流程</h2></li>
</ul>
<ol>
<li>上传图片<ul>
<li>教学机构人员在课程信息编辑页面上传课程图片，课程图片统一记录在媒资管理系统</li>
</ul>
</li>
<li>上传视频<ul>
<li>教学机构人员进入媒资管理列表查询自己上传的媒资文件</li>
<li>教育机构用户在媒资管理页面中点击上传视频按钮</li>
<li>选择要上传的文件，自动执行文件上传</li>
<li>视频上传成功会自动处理，处理完成后可以预览视频</li>
</ul>
</li>
<li>处理视频<ul>
<li>对需要转码处理的视频，系统会自动对齐处理，处理后生成视频的URL</li>
</ul>
</li>
<li>审核媒资<ul>
<li>运营用户登入运营平台，并进入媒资管理界面，查找待审核媒资</li>
<li>点击列表中媒资名称链接，可以预览该媒资，若是视频，则播放视频</li>
<li>点击列表中某媒资后的审核按钮，即完成媒资的审批过程</li>
<li>审核媒资包括程序自动审核和人工审核，程序可以通过鉴黄接口(<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/lvwang?spm=5176.19720258.J_3207526240.51.e93976f4rSq796)审核视频，对有异议的视频由人工进行审核。">https://www.aliyun.com/product/lvwang?spm=5176.19720258.J_3207526240.51.e93976f4rSq796)审核视频，对有异议的视频由人工进行审核。</a></li>
</ul>
</li>
<li>绑定媒资<ul>
<li>课程计划创建好后需要绑定媒资文件，比如：如果课程计划绑定了视频文件，进入课程在线学习界面后，点课程计划名称则在线播放视频</li>
<li>如何将课程计划绑定媒资呢？</li>
<li>教育机构用户进入课程管理页面编辑某一课程，在课程大纲编辑页的某一小节后，可以添加媒资信息</li>
<li>点击添加视频，会弹出对话框，可通过输入视频关键字搜索已审核通过的视频媒资</li>
<li>选择视频媒资，点击提交安努，完成课程计划绑定媒资流程<h2 id="1-3数据模型"><a href="#1-3数据模型" class="headerlink" title="1.3数据模型"></a>1.3数据模型</h2><details class="folding-tag" green><summary> 本模块媒资文件相关的数据表 </summary>
              <div class='content'>
              <p><img src="![Alt text](&lt;Pasted image 20240511144831.png" alt="code">)</p><ul><li>媒资文件表：存储文件信息，包括图片、视频、文档等。</li><li>media_process: 待处理视频表。</li><li>media_process_history: 视频处理历史表，记录已经处理成功的视频信息。</li></ul>
              </div>
            </details>
<details class="folding-tag" green><summary> 媒资文件与课程计划绑定关系表 </summary>
              <div class='content'>
              <p><img src="https://pic.imgdb.cn/item/66471c1ed9c307b7e91112ee.png" alt="code"></p>
              </div>
            </details>
<h1 id="2-搭建模块环境"><a href="#2-搭建模块环境" class="headerlink" title="2.搭建模块环境"></a>2.搭建模块环境</h1><h2 id="2-1构建问题分析"><a href="#2-1构建问题分析" class="headerlink" title="2.1构建问题分析"></a>2.1构建问题分析</h2></li>
</ul>
</li>
</ol>
<ul>
<li>当前这种由<span class='p red'>前端直接请求</span>微服务的方式存在<span class='p red'>弊端</span>：</li>
<li>如果在前端对每个请求地址都配置绝对路径，非常不利于系统维护，比如下边代码中请求系统管理服务的地址使用的是localhost<br><img src="https://pic.imgdb.cn/item/66472026d9c307b7e9168e3c.jpg" alt="code"></li>
<li>基于这个问题可以采用网关来解决，如下图：<br><img src="https://pic.imgdb.cn/item/66471e21d9c307b7e91450a3.jpg" alt="code"></li>
<li>这样在前端的代码中只需要指定每个接口的相对路径，如下所示：<br><img src="https://pic.imgdb.cn/item/66472064d9c307b7e916d37f.jpg" alt="code"></li>
<li>有了网关就可以对请求进行路由，路由到具体的微服务，减少外界对接微服务的成本，比如：400电话，路由的试可以根据请求路径进行路由、根据host地址进行路由等， 当微服务有多个实例时可以通过<span class='p red'>负载均衡算法</span>进行路由</li>
<li>另外，网关还可以实现<span class='p red'>权限控制、限流</span>等功能。</li>
<li>项目采用<span class='p red'>Spring Cloud Gateway作为网关</span>，网关在请求路由时需要知道每个微服务实例的地址，项目使用<span class='p red'>Nacos作用服务发现中心和配置中心</span>，整体的架构图如下：<br><img src="https://pic.imgdb.cn/item/66472109d9c307b7e9177b65.jpg" alt="code"><h2 id="2-2搭建Nacos"><a href="#2-2搭建Nacos" class="headerlink" title="2.2搭建Nacos"></a>2.2搭建Nacos</h2><h3 id="2-2-1服务发现中心"><a href="#2-2-1服务发现中心" class="headerlink" title="2.2.1服务发现中心"></a>2.2.1服务发现中心</h3>访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:8848/nacos/">http://192.168.101.65:8848/nacos/</a><br>账号密码：nacos/nacos</li>
</ul>
<ol>
<li>创建命名空间<br><img src="https://pic.imgdb.cn/item/66473441d9c307b7e93c793e.png" alt="code"></li>
<li>在parent中添加依赖<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>在api模块中添加依赖(需要请求的模块都要添加)<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>修改yaml文件<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span>  </span><br><span class="line">  <span class="attr">application:</span>  </span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span>  </span><br><span class="line">  <span class="attr">cloud:</span>  </span><br><span class="line">    <span class="attr">nacos:</span>  </span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span>  </span><br><span class="line">      <span class="attr">discovery:</span>  </span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span>  </span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br></pre></td></tr></table></figure></li>
<li>重启查看<br><img src="https://pic.imgdb.cn/item/6647350dd9c307b7e93d5497.png" alt="code"><h3 id="2-2-2配置中心"><a href="#2-2-2配置中心" class="headerlink" title="2.2.2配置中心"></a>2.2.2配置中心</h3><details class="folding-tag" green><summary> 配置api </summary>
              <div class='content'>
              <ol><li>添加依赖<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li><li>nacos如何去<code>定位一个具体的配置文件</code>，即：namespace、group、dataid.</li></ol><ul><li>以下配置的文件名为：content-api-dev.yaml<br><img src="https://pic.imgdb.cn/item/664735c2d9c307b7e93e0b41.png" alt="code"></li></ul><ol><li>添加配置<br><img src="https://pic.imgdb.cn/item/664735f4d9c307b7e93e4443.png" alt="code"></li><li>扩展（依赖）配置文件和引用公共文件<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nacos:</span>  </span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span>  </span><br><span class="line">      <span class="attr">discovery:</span>  </span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span>  </span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span>  </span><br><span class="line">      <span class="attr">config:</span>  </span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span>  </span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span>  </span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span>  </span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span>  </span><br><span class="line">        <span class="attr">extension-configs:</span>  </span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span>  </span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span>  </span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span>  </span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">swagger-$&#123;spring.profiles.active&#125;.yaml</span>  </span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span>  </span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span>  </span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span>  </span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span>  </span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li></ol>
              </div>
            </details>
<details class="folding-tag" green><summary> 配置优先级 </summary>
              <div class='content'>
              <p><img src="https://pic.imgdb.cn/item/66473640d9c307b7e93e8b05.png" alt="code"></p><ul><li>引入配置文件的形式有：<ol><li>以项目应用名方式引入</li><li>以扩展配置文件方式引入</li><li>以共享配置文件 方式引入</li><li>本地配置文件</li></ol></li><li>项目应用名配置文件 &gt; 扩展配置文件  &gt; 共享配置文件 &gt; 本地配置文件</li><li>在项目nacos配置文件里面添加<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">配置本地优先</span>  </span><br><span class="line"><span class="attr">spring:</span>  </span><br><span class="line"> <span class="attr">cloud:</span>  </span><br><span class="line">  <span class="attr">config:</span>  </span><br><span class="line">    <span class="attr">override-none:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li></ul>
              </div>
            </details>
</li>
</ol>
<h2 id="2-3搭建网关"><a href="#2-3搭建网关" class="headerlink" title="2.3搭建网关"></a>2.3搭建网关</h2><ol>
<li>创建xuecheng-plus-gateway模块</li>
<li>导入依赖<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../xuecheng-plus-parent<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">&lt;!--网关--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">&lt;!--服务发现中心--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span>  </span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span>        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>把api里面的resources文件夹拷贝过来<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#微服务配置  </span></span><br><span class="line"><span class="attr">spring:</span>  </span><br><span class="line">  <span class="attr">application:</span>  </span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span>  </span><br><span class="line">  <span class="attr">cloud:</span>  </span><br><span class="line">    <span class="attr">nacos:</span>  </span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span>  </span><br><span class="line">      <span class="attr">discovery:</span>  </span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev001</span>  </span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span>  </span><br><span class="line">      <span class="attr">config:</span>  </span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev001</span>  </span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span>  </span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span>  </span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span>  </span><br><span class="line">        <span class="attr">shared-configs:</span>  </span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span>  </span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span>  </span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span>  </span><br><span class="line">  <span class="attr">profiles:</span>  </span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure></li>
<li>运行启动类，并在nacos中查看是否运行成功</li>
<li>在测试接口中测试<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST &#123;&#123;gateway_host&#125;&#125;/content/course/list?pageNo=<span class="number">1</span>&amp;pageSize=<span class="number">2</span></span><br></pre></td></tr></table></figure>
<h2 id="2-4搭建媒资工程"><a href="#2-4搭建媒资工程" class="headerlink" title="2.4搭建媒资工程"></a>2.4搭建媒资工程</h2>直接在导入后设置bootstrap<h1 id="3-分布式文件系统"><a href="#3-分布式文件系统" class="headerlink" title="3.分布式文件系统"></a>3.分布式文件系统</h1><h2 id="3-1介绍"><a href="#3-1介绍" class="headerlink" title="3.1介绍"></a>3.1介绍</h2></li>
</ol>
<ul>
<li>文件系统是<span class='p red'>负责管理和存储文件</span>的系统软件，操作系统通过文件系统提供的接口去存取文件，用户通过操作系统访问磁盘上的文件。<br><img src="https://pic.imgdb.cn/item/66473a03d9c307b7e9440bf4.png" alt="code"></li>
<li>通过概念可以简单理解为：一个计算机无法存储海量的文件，通过网络将若干计算机组织起来<code>共同去存储</code>海量的文件，去接收海量用户的请求，这些组织起来的计算机通过网络进行通信，如下图：<br><img src="https://pic.imgdb.cn/item/66473aa0d9c307b7e945894a.jpg" alt="code"></li>
<li>好处：<ol>
<li>一台计算机的文件系统处理能力扩充到多台计算机同时处理。</li>
<li>一台计算机挂了还有另外副本计算机提供数据。</li>
<li>每台计算机可以放在不同的地域，这样用户就可以就近访问，提高访问速度。</li>
</ol>
</li>
<li>市面上有哪些分布式文件系统的产品呢？</li>
</ul>
<ol>
<li>NFS<ul>
<li>阅读百度百科：<br><img src="https://pic.imgdb.cn/item/66473d46d9c307b7e9487569.jpg" alt=""><br><img src="https://pic.imgdb.cn/item/66473d62d9c307b7e948931c.jpg" alt=""> </li>
<li>特点：<ul>
<li>在客户端上映射NFS服务器的驱动器。</li>
<li>客户端通过网络访问NFS服务器的硬盘完全透明。</li>
</ul>
</li>
</ul>
</li>
<li><p>GFS<br> <img src="https://pic.imgdb.cn/item/66473d7bd9c307b7e948b347.jpg" alt=""><br> <img src="https://pic.imgdb.cn/item/66473d8ad9c307b7e948c81d.jpg" alt=""> </p>
<ul>
<li>GFS采用主从结构，一个GFS集群由一个master和大量的chunkserver组成。</li>
<li>master存储了数据文件的元数据，一个文件被分成了若干块存储在多个chunkserver中。</li>
<li>用户从master中获取数据元信息，向chunkserver存储数据。</li>
</ul>
</li>
<li><p>HDFS</p>
<ul>
<li>HDFS，是Hadoop Distributed File System的简称，是Hadoop抽象文件系统的一种实现。HDFS是一个高度容错性的系统，适合部署在廉价的机器上。HDFS能提供高吞吐量的数据访问，非常适合大规模数据集上的应用。 HDFS的文件分布在集群机器上，同时提供副本进行容错及可靠性保证。例如客户端写入读取文件的直接操作都是分布在集群各个机器上的，没有单点性能压力。</li>
<li>下图是HDFS的架构图：<br>  <img src="https://pic.imgdb.cn/item/66473da3d9c307b7e948e352.jpg" alt=""> <ul>
<li>HDFS采用主从结构，一个HDFS集群由一个名称结点和若干数据结点组成。</li>
<li>名称结点存储数据的元信息，一个完整的数据文件分成若干块存储在数据结点。</li>
<li>客户端从名称结点获取数据的元信息及数据分块的信息，得到信息客户端即可从数据块来存取数据。</li>
</ul>
</li>
</ul>
</li>
<li><p>云计算厂家</p>
<ul>
<li>阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。其数据设计持久性不低于 99.9999999999%（12 个 9），服务设计可用性（或业务连续性）不低于 99.995%。</li>
<li>官方网站：<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/oss"><em>https://www.aliyun.com/product/oss</em></a> </li>
<li>百度对象存储BOS提供稳定、安全、高效、高可扩展的云存储服务。您可以将任意数量和形式的非结构化数据存入BOS，并对数据进行管理和处理。BOS支持标准、低频、冷和归档存储等多种存储类型，满足多场景的存储需求。</li>
<li>官方网站：<a target="_blank" rel="noopener" href="https://cloud.baidu.com/product/bos.html"><em>https://cloud.baidu.com/product/bos.html</em></a></li>
</ul>
</li>
</ol>
<h2 id="3-2minio文件系统"><a href="#3-2minio文件系统" class="headerlink" title="3.2minio文件系统"></a>3.2minio文件系统</h2><h3 id="3-2-1介绍"><a href="#3-2-1介绍" class="headerlink" title="3.2.1介绍"></a>3.2.1介绍</h3><p>官网：<a target="_blank" rel="noopener" href="https://min.io">https://min.io</a><br>中文：<a target="_blank" rel="noopener" href="https://www.minio.org.cn/">https://www.minio.org.cn/</a><br>    <a target="_blank" rel="noopener" href="http://docs.minio.org.cn/docs/">http://docs.minio.org.cn/docs/</a></p>
<ul>
<li>MinIO 是一个非常<span class='p red'>轻量</span>的服务,可以很简单的和其他应用的结合使用，它兼容亚马逊 S3 云存储服务接口，非常适合于<span class='p red'>存储大容量非结构化的数据</span>，例如图片、视频、日志文件、备份数据和容器/虚拟机镜像等。</li>
<li>它一大特点就是轻量，使用简单，功能强大，支持各种平台，单个文件最大5TB，兼容 Amazon S3接口，提供了 Java、Python、GO等多版本SDK支持。</li>
<li>MinIO集群采用<span class='p red'>去中心化共享架构</span>，每个结点是<span class='p red'>对等关系</span>，通过Nginx可对MinIO进行负载均衡访问。<br><img src="https://pic.imgdb.cn/item/66474171d9c307b7e94d821f.png" alt="code"></li>
<li>Minio使用<span class='p red'>纠删码技术来保护数据</span>，它是一种恢复丢失和损坏数据的数学算法，它将数据分块冗余的分散存储在各各节点的磁盘上，所有的可用磁盘组成一个集合，上图由8块硬盘组成一个集合，当上传一个文件时会通过纠删码算法计算对文件进行分块存储，除了将文件本身分成<span class='p red'>4个数据块</span>，还会生成<span class='p red'>4个校验块</span>，数据块和校验块会分散的存储在这8块硬盘上。</li>
<li>使用纠删码的好处是即便<span class='p red'>丢失一半数量（N/2）的硬盘，仍然可以恢复数据</span>。 比如上边集合中有4个以内的硬盘损害仍可保证数据恢复，不影响上传和下载，如果多于一半的硬盘坏了则无法恢复。</li>
</ul>
<h3 id="3-2-2window使用"><a href="#3-2-2window使用" class="headerlink" title="3.2.2window使用"></a>3.2.2window使用</h3><ol>
<li>创建4个目录表示4块硬盘</li>
<li>CMD进入有minio.exe的目录<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minio.exe server D:\develop\minio_data\data1  D:\develop\minio_data\data2  D:\develop\minio_data\data3  D:\develop\minio_data\data4</span><br></pre></td></tr></table></figure>
<img src="https://pic.imgdb.cn/item/664742d4d9c307b7e94f426e.png" alt="code"></li>
<li>按上面给出的链接登录（账号密码默认为minioadmin）</li>
<li>虚拟机链接：<a target="_blank" rel="noopener" href="http://192.168.101.65:9000">http://192.168.101.65:9000</a><h3 id="3-2-3本地测试文件和视频方法"><a href="#3-2-3本地测试文件和视频方法" class="headerlink" title="3.2.3本地测试文件和视频方法"></a>3.2.3本地测试文件和视频方法</h3></li>
</ol>
<ul>
<li>导入依赖<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="3-2-3-1minio上传-删除-下载文件"><a href="#3-2-3-1minio上传-删除-下载文件" class="headerlink" title="3.2.3.1minio上传/删除/下载文件"></a>3.2.3.1minio上传/删除/下载文件</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media;  </span><br><span class="line"><span class="keyword">import</span> com.j256.simplemagic.ContentInfo;  </span><br><span class="line"><span class="keyword">import</span> com.j256.simplemagic.ContentInfoUtil;  </span><br><span class="line"><span class="keyword">import</span> io.minio.*;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.digest.DigestUtils;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.compress.utils.IOUtils;  </span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;  </span><br><span class="line"><span class="keyword">import</span> java.io.File;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.FilterInputStream;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioTest</span> &#123;  </span><br><span class="line">    <span class="keyword">static</span> <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span>  </span><br><span class="line">            MinioClient.builder()  </span><br><span class="line">                    .endpoint(<span class="string">&quot;http://192.168.101.65:9000&quot;</span>)  </span><br><span class="line">                    .credentials(<span class="string">&quot;minioadmin&quot;</span>, <span class="string">&quot;minioadmin&quot;</span>)  </span><br><span class="line">                    .build();  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_upload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="comment">//通过扩展名得到媒体资源类型 mineType      </span></span><br><span class="line">          <span class="type">ContentInfo</span> <span class="variable">extensionMatch</span> <span class="operator">=</span> ContentInfoUtil.findExtensionMatch(<span class="string">&quot;.mp4&quot;</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;</span><br><span class="line">        <span class="comment">//通用mimeType，字节流  </span></span><br><span class="line">        <span class="keyword">if</span> (extensionMatch != <span class="literal">null</span>) &#123;  </span><br><span class="line">            mimeType = extensionMatch.getMimeType();  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//上传文件参数信息  </span></span><br><span class="line">        <span class="type">UploadObjectArgs</span> <span class="variable">uploadObjectArgs</span> <span class="operator">=</span> UploadObjectArgs.builder()  </span><br><span class="line">                .bucket(<span class="string">&quot;testbucket&quot;</span>)<span class="comment">//桶  </span></span><br><span class="line">                .filename(<span class="string">&quot;D:\\1.mp4&quot;</span>)<span class="comment">//本地文件路径  </span></span><br><span class="line">                <span class="comment">//        .object(&quot;1.mp4&quot;)//对象名  </span></span><br><span class="line">                .object(<span class="string">&quot;test/1/1.pm4&quot;</span>) <span class="comment">//设置多层目录  </span></span><br><span class="line">                .contentType(mimeType) <span class="comment">//设置媒体文件类型  </span></span><br><span class="line">                .build();  </span><br><span class="line">        <span class="comment">//上传文件  </span></span><br><span class="line">        minioClient.uploadObject(uploadObjectArgs);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_delete</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//文件参数信息  </span></span><br><span class="line">        <span class="type">RemoveObjectArgs</span> <span class="variable">deleteObject</span> <span class="operator">=</span> RemoveObjectArgs.builder()  </span><br><span class="line">                .bucket(<span class="string">&quot;testbucket&quot;</span>)  </span><br><span class="line">                .object(<span class="string">&quot;test/1/1.pm4&quot;</span>)  </span><br><span class="line">                .build();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//删除文件  </span></span><br><span class="line">        minioClient.removeObject(deleteObject);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//查询文件 从minio中下载  </span></span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_getFile</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">GetObjectArgs</span> <span class="variable">getObjectArgs</span> <span class="operator">=</span> GetObjectArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).object(<span class="string">&quot;test/1/1.pm4&quot;</span>).build();  </span><br><span class="line">        <span class="comment">//查询远程服务获取到一个流对象  </span></span><br><span class="line">        <span class="type">FilterInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioClient.getObject(getObjectArgs);  </span><br><span class="line">        <span class="comment">//指定输出流  </span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\1a.mp4&quot;</span>));  </span><br><span class="line">        IOUtils.copy(inputStream, outputStream);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//校验文件的完整性对文件的内容进行md5  </span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\1.mp4&quot;</span>));  </span><br><span class="line">        <span class="type">String</span> <span class="variable">source_md5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream1);  </span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\1a.mp4&quot;</span>));  </span><br><span class="line">        <span class="type">String</span> <span class="variable">local_md5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream);  </span><br><span class="line">        <span class="keyword">if</span> (source_md5.equals(local_md5)) &#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;下载成功&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-2-3-2本地拆分-合并大文件方法"><a href="#3-2-3-2本地拆分-合并大文件方法" class="headerlink" title="3.2.3.2本地拆分/合并大文件方法"></a>3.2.3.2本地拆分/合并大文件方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BigFileTest</span> &#123;  </span><br><span class="line">    <span class="comment">//分块测试  </span></span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testChunk</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="comment">//源文件  </span></span><br><span class="line">        <span class="type">File</span> <span class="variable">sourceFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\1视频\\下载 (1).mp4&quot;</span>);  </span><br><span class="line">        <span class="comment">//分块文件存储路径  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> <span class="string">&quot;D:\\1视频\\chunk\\&quot;</span>;  </span><br><span class="line">        <span class="comment">//分块文件大小  </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">chunkSize</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> *<span class="number">5</span>;  </span><br><span class="line">        <span class="comment">//分块文件个数  </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">chunkNum</span> <span class="operator">=</span> (<span class="type">int</span>) Math.ceil(sourceFile.length() * <span class="number">1.0</span> / chunkSize); </span><br><span class="line">        <span class="comment">//使用流从源文件读数据，向分块文件中写数据  </span></span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">raf_r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(sourceFile, <span class="string">&quot;r&quot;</span>);  </span><br><span class="line">        <span class="comment">//缓存区  </span></span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i &lt; chunkNum;i++)&#123;  </span><br><span class="line">            <span class="type">File</span> <span class="variable">chunkfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(chunkFilePath + i);  </span><br><span class="line">            <span class="comment">//分块文件写入流  </span></span><br><span class="line">            <span class="type">RandomAccessFile</span> <span class="variable">raf_rw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(chunkfile, <span class="string">&quot;rw&quot;</span>);  </span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;  </span><br><span class="line">            <span class="keyword">while</span> ((len=raf_r.read(bytes)) != -<span class="number">1</span>)&#123;  </span><br><span class="line">                raf_rw.write(bytes,<span class="number">0</span>,len);  </span><br><span class="line">                <span class="keyword">if</span> (chunkfile.length() &gt;= chunkSize)&#123;  </span><br><span class="line">                    <span class="keyword">break</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">            raf_rw.close();  </span><br><span class="line">        &#125;  </span><br><span class="line">        raf_r.close();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//将分块合并  </span></span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMerge</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="comment">//块文件目录  </span></span><br><span class="line">        <span class="type">File</span> <span class="variable">chunkFolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\1视频\\chunk&quot;</span>);  </span><br><span class="line">        <span class="comment">//源文件  </span></span><br><span class="line">        <span class="type">File</span> <span class="variable">sourceFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\1视频\\下载 (1).mp4&quot;</span>);  </span><br><span class="line">        <span class="comment">//合并后的文件路径  </span></span><br><span class="line">        <span class="type">File</span> <span class="variable">mergeFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\1视频\\下载 (1)_2.mp4&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//取出所有分块文件  </span></span><br><span class="line">        File[] files = chunkFolder.listFiles();  </span><br><span class="line">        <span class="comment">//将数组转成list  </span></span><br><span class="line">        List&lt;File&gt; filesList = Arrays.asList(files);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//排序  </span></span><br><span class="line">        Collections.sort(filesList, <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;File&gt;() &#123;  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(File o1, File o2)</span> &#123;  </span><br><span class="line">                <span class="keyword">return</span> Integer.parseInt(o1.getName())-Integer.parseInt(o2.getName());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//向合并文件写的流  </span></span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">raf_rw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(mergeFile, <span class="string">&quot;rw&quot;</span>);  </span><br><span class="line">        <span class="comment">//缓存区  </span></span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];  </span><br><span class="line">        <span class="comment">//遍历分块文件，向合并的文件写  </span></span><br><span class="line">        <span class="keyword">for</span> (File file : filesList) &#123;  </span><br><span class="line">            <span class="type">RandomAccessFile</span> <span class="variable">raf_r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(file, <span class="string">&quot;r&quot;</span>);  </span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;  </span><br><span class="line">            <span class="keyword">while</span> ((len=raf_r.read(bytes)) != -<span class="number">1</span>)&#123;  </span><br><span class="line">                raf_rw.write(bytes,<span class="number">0</span>,len);  </span><br><span class="line">            &#125;  </span><br><span class="line">            raf_r.close();  </span><br><span class="line">        &#125;  </span><br><span class="line">        raf_rw.close();  </span><br><span class="line">        <span class="comment">//合并文件完成后校验  </span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream_merge</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(mergeFile);  </span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream_source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(sourceFile);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">md5_merge</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream_merge);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">md5_source</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream_source);  </span><br><span class="line">        <span class="keyword">if</span> (md5_merge.equals(md5_source))&#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;文件合并完成&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-2-3-3minio拆分合并大文件方法"><a href="#3-2-3-3minio拆分合并大文件方法" class="headerlink" title="3.2.3.3minio拆分合并大文件方法"></a>3.2.3.3minio拆分合并大文件方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioTest</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span>  </span><br><span class="line">            MinioClient.builder()  </span><br><span class="line">                    .endpoint(<span class="string">&quot;http://192.168.101.65:9000&quot;</span>)  </span><br><span class="line">                    .credentials(<span class="string">&quot;minioadmin&quot;</span>, <span class="string">&quot;minioadmin&quot;</span>)  </span><br><span class="line">                    .build();</span><br><span class="line">                    </span><br><span class="line">    <span class="comment">//查询文件 从minio中下载  </span></span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_getFile</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">GetObjectArgs</span> <span class="variable">getObjectArgs</span> <span class="operator">=</span> GetObjectArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).object(<span class="string">&quot;test/1/1.pm4&quot;</span>).build();  </span><br><span class="line">        <span class="comment">//查询远程服务获取到一个流对象  </span></span><br><span class="line">        <span class="type">FilterInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioClient.getObject(getObjectArgs);  </span><br><span class="line">        <span class="comment">//指定输出流  </span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\1a.mp4&quot;</span>));  </span><br><span class="line">        IOUtils.copy(inputStream, outputStream);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//校验文件的完整性对文件的内容进行md5  </span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\1.mp4&quot;</span>));  </span><br><span class="line">        <span class="type">String</span> <span class="variable">source_md5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream1);  </span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\1a.mp4&quot;</span>));  </span><br><span class="line">        <span class="type">String</span> <span class="variable">local_md5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream);  </span><br><span class="line">        <span class="keyword">if</span> (source_md5.equals(local_md5)) &#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;下载成功&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//将分块文件上传到minio  </span></span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadChunk</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;  </span><br><span class="line">            <span class="comment">//上传文件参数信息  </span></span><br><span class="line">            <span class="type">UploadObjectArgs</span> <span class="variable">uploadObjectArgs</span> <span class="operator">=</span> UploadObjectArgs.builder()  </span><br><span class="line">                    .bucket(<span class="string">&quot;testbucket&quot;</span>)<span class="comment">//桶  </span></span><br><span class="line">                    .filename(<span class="string">&quot;D:\\1视频\\chunk\\&quot;</span>+i)<span class="comment">//本地文件路径  </span></span><br><span class="line">                    .object(<span class="string">&quot;chunk/&quot;</span>+i) <span class="comment">//设置多层目录  </span></span><br><span class="line">                    .build();  </span><br><span class="line">            <span class="comment">//上传文件  </span></span><br><span class="line">            minioClient.uploadObject(uploadObjectArgs);  </span><br><span class="line">            System.out.println(<span class="string">&quot;上传分块&quot;</span>+i+<span class="string">&quot;成功&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//调用minio接口合并分块  </span></span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMerge</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">  </span><br><span class="line">        List&lt;ComposeSource&gt; sources = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;  </span><br><span class="line">            <span class="comment">//指定分块文件的信息  </span></span><br><span class="line">            <span class="type">ComposeSource</span> <span class="variable">composeSource</span> <span class="operator">=</span> ComposeSource  </span><br><span class="line">                    .builder()  </span><br><span class="line">                    .bucket(<span class="string">&quot;testbucket&quot;</span>)  </span><br><span class="line">                    .object(<span class="string">&quot;chunk/&quot;</span> + i)  </span><br><span class="line">                    .build();  </span><br><span class="line">            sources.add(composeSource);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//指定合并后的objectName等信息  </span></span><br><span class="line">        <span class="type">ComposeObjectArgs</span> <span class="variable">composeObjectArgs</span> <span class="operator">=</span> ComposeObjectArgs.builder()  </span><br><span class="line">                .bucket(<span class="string">&quot;testbucket&quot;</span>)  </span><br><span class="line">                .object(<span class="string">&quot;merge01.mp4&quot;</span>)  </span><br><span class="line">                .sources(sources) <span class="comment">//指定源文件  </span></span><br><span class="line">                .build();  </span><br><span class="line">        <span class="comment">//合并文件  </span></span><br><span class="line">        minioClient.composeObject(composeObjectArgs);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//批量清理分块文件  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-上传文件"><a href="#4-上传文件" class="headerlink" title="4.上传文件"></a>4.上传文件</h1><h2 id="4-1需求分析"><a href="#4-1需求分析" class="headerlink" title="4.1需求分析"></a>4.1需求分析</h2></li>
<li>媒资管理服务的作用：<span class='p red'>对文件进行统一管理，文件本身放在minio，文件信息放在media_files表中</span></li>
<li>course_base表中的pic地址为<span class='p red'>桶的地址路径</span>，前端会把minio的地址进行<span class='p red'>拼接</span><br><img src="https://pic.imgdb.cn/item/664744c1d9c307b7e951c39b.png" alt="code"><br><img src="https://pic.imgdb.cn/item/664744eed9c307b7e9520481.png" alt="code"></li>
<li>数据模型<br><img src="https://pic.imgdb.cn/item/6647452dd9c307b7e9525b4c.png" alt="code"><h2 id="4-2准备工作"><a href="#4-2准备工作" class="headerlink" title="4.2准备工作"></a>4.2准备工作</h2></li>
</ul>
<ol>
<li>把minio里面的桶改为public</li>
<li>在nacos配置中minio的相关信息<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">minio:</span>  </span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">http://192.168.101.65:9000</span>  </span><br><span class="line">  <span class="attr">accessKey:</span> <span class="string">minioadmin</span>  </span><br><span class="line">  <span class="attr">secretKey:</span> <span class="string">minioadmin</span>  </span><br><span class="line">  <span class="attr">bucket:</span>  </span><br><span class="line">    <span class="attr">files:</span> <span class="string">mediafiles</span>  </span><br><span class="line">    <span class="attr">videofiles:</span> <span class="string">video</span></span><br></pre></td></tr></table></figure></li>
<li>在media-service工程编写minio的配置类：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.config;  </span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioConfig</span> &#123;  </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.endpoint&#125;&quot;)</span>  </span><br><span class="line">    <span class="keyword">private</span> String endpoint;  </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.accessKey&#125;&quot;)</span>  </span><br><span class="line">    <span class="keyword">private</span> String admin;  </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.secretKey&#125;&quot;)</span>  </span><br><span class="line">    <span class="keyword">private</span> String passwork;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> MinioClient <span class="title function_">minioClient</span><span class="params">()</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span>  </span><br><span class="line">            MinioClient.builder()  </span><br><span class="line">                    .endpoint(endpoint)  </span><br><span class="line">                    .credentials(admin, passwork)  </span><br><span class="line">                    .build();  </span><br><span class="line">    <span class="keyword">return</span> minioClient;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-3接口定义"><a href="#4-3接口定义" class="headerlink" title="4.3接口定义"></a>4.3接口定义</h2></li>
</ol>
<ul>
<li>首先分析接口：</li>
<li>请求地址：/media/upload/coursefile</li>
<li>请求内容：<strong>Content-Type:</strong> multipart/form-data;</li>
<li>form-data; name=”filedata”; filename=”具体的文件名称”</li>
<li>响应参数：文件信息，如下<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;companyId&quot;</span><span class="punctuation">:</span> <span class="number">1232141425</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;companyName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.jpg&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;fileType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;001001&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;bucket&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;fileId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;timelength&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-09-12T21:57:18&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;changeDate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;auditMind&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span>  </span><br><span class="line">  <span class="attr">&quot;fileSize&quot;</span><span class="punctuation">:</span> <span class="number">248329</span>  </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li>创建响应实体类（防止前端要加数据，导致修改数据库表）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.model.dto;  </span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;  </span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadFileResultDto</span> <span class="keyword">extends</span> <span class="title class_">MediaFiles</span> &#123;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>MediaFilesController接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;上传图片&quot;)</span>  </span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/upload/coursefile&quot;,consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span>  </span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFileResultDto</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile filedata)</span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//调用service上传图片  </span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-4接口实现"><a href="#4-4接口实现" class="headerlink" title="4.4接口实现"></a>4.4接口实现</h2></li>
<li>MediaFileService接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//上传文件  </span></span><br><span class="line"><span class="comment">//参数：1.机构id  2.请求参数  3.本地路径  </span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//将文件上传到minio  </span></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName)</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>MediaFileServiceImpl</p>
<div class="tabs" id="test1"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="test1-1">主方法</button><button type="button" class="tab " data-href="test1-2">getMimeType</button><button type="button" class="tab " data-href="test1-3">addMediaFilesToMinIO</button><button type="button" class="tab " data-href="test1-4">getDefaultFolderPath</button><button type="button" class="tab " data-href="test1-5">getFileMd5</button><button type="button" class="tab " data-href="test1-6">addMediaFilesToDb</button></ul><div class="tab-contents"><div class="tab-item-content active" id="test1-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaFileServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MediaFileService</span> &#123;  </span><br><span class="line"> <span class="meta">@Autowired</span>  </span><br><span class="line"> MediaFilesMapper mediaFilesMapper; </span><br><span class="line"> <span class="meta">@Autowired</span>  </span><br><span class="line"> MinioClient minioClient;  </span><br><span class="line"> <span class="meta">@Autowired</span>  </span><br><span class="line"> MediaFileService currentProxy;  </span><br><span class="line"> <span class="comment">//存储普通文件  </span></span><br><span class="line"> <span class="meta">@Value(&quot;$&#123;minio.bucket.files&#125;&quot;)</span>  </span><br><span class="line"> <span class="keyword">private</span> String bucket_mediafiles;  </span><br><span class="line"> <span class="comment">//存储视频  </span></span><br><span class="line"> <span class="meta">@Value(&quot;$&#123;minio.bucket.videofiles&#125;&quot;)</span>  </span><br><span class="line"> <span class="keyword">private</span> String bucket_video;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span> &#123;  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">//文件名  </span></span><br><span class="line"> <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> uploadFileParamsDto.getFilename();  </span><br><span class="line"> <span class="comment">//先得到扩展名  </span></span><br><span class="line"> <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>));  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">//得到mimeType  </span></span><br><span class="line"> <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> getMimeType(extension);  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">//子目录  </span></span><br><span class="line"> <span class="type">String</span> <span class="variable">defaultFolderPath</span> <span class="operator">=</span> getDefaultFolderPath();  </span><br><span class="line"> <span class="comment">//文件的md5值  </span></span><br><span class="line"> <span class="type">String</span> <span class="variable">fileMd5</span> <span class="operator">=</span> getFileMd5(<span class="keyword">new</span> <span class="title class_">File</span>(localFilePath));  </span><br><span class="line"> <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> defaultFolderPath+fileMd5+extension;  </span><br><span class="line"> <span class="comment">//上传文件到minio  </span></span><br><span class="line"> <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> addMediaFilesToMinIO(localFilePath, mimeType, bucket_mediafiles, objectName);  </span><br><span class="line"> <span class="keyword">if</span>(!result)&#123;  </span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;上传文件失败&quot;</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line"> <span class="comment">//入库文件信息  </span></span><br><span class="line"> <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> currentProxy.addMediaFilesToDb(companyId, fileMd5, uploadFileParamsDto, bucket_mediafiles, objectName);  </span><br><span class="line"> <span class="keyword">if</span>(mediaFiles==<span class="literal">null</span>)&#123;  </span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;文件上传后保存信息失败&quot;</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line"> <span class="comment">//准备返回的对象  </span></span><br><span class="line"> <span class="type">UploadFileResultDto</span> <span class="variable">uploadFileResultDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileResultDto</span>();  </span><br><span class="line"> BeanUtils.copyProperties(mediaFiles,uploadFileResultDto);  </span><br><span class="line"> <span class="keyword">return</span> uploadFileResultDto;  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="test1-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据扩展名获取mimeType  </span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getMimeType</span><span class="params">(String extension)</span>&#123;  </span><br><span class="line"> <span class="keyword">if</span>(extension == <span class="literal">null</span>)&#123;  </span><br><span class="line">  extension = <span class="string">&quot;&quot;</span>;  </span><br><span class="line"> &#125;  </span><br><span class="line"> <span class="comment">//根据扩展名取出mimeType  </span></span><br><span class="line"> <span class="type">ContentInfo</span> <span class="variable">extensionMatch</span> <span class="operator">=</span> ContentInfoUtil.findExtensionMatch(extension);  </span><br><span class="line"> <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;<span class="comment">//通用mimeType，字节流  </span></span><br><span class="line"> <span class="keyword">if</span>(extensionMatch!=<span class="literal">null</span>)&#123;  </span><br><span class="line">  mimeType = extensionMatch.getMimeType();  </span><br><span class="line"> &#125;  </span><br><span class="line"> <span class="keyword">return</span> mimeType;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="test1-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 将文件上传到minio  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> localFilePath 文件本地路径  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mimeType 媒体类型  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket 桶  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addMediaFilesToMinIO</span><span class="params">(String localFilePath,String mimeType,String bucket, String objectName)</span>&#123;  </span><br><span class="line"> <span class="keyword">try</span> &#123;  </span><br><span class="line">  <span class="type">UploadObjectArgs</span> <span class="variable">uploadObjectArgs</span> <span class="operator">=</span> UploadObjectArgs.builder()  </span><br><span class="line">          .bucket(bucket)<span class="comment">//桶  </span></span><br><span class="line">          .filename(localFilePath) <span class="comment">//指定本地文件路径  </span></span><br><span class="line">          .object(objectName)<span class="comment">//对象名 放在子目录下  </span></span><br><span class="line">          .contentType(mimeType)<span class="comment">//设置媒体文件类型  </span></span><br><span class="line">          .build();  </span><br><span class="line">  <span class="comment">//上传文件  </span></span><br><span class="line">  minioClient.uploadObject(uploadObjectArgs);  </span><br><span class="line">  log.debug(<span class="string">&quot;上传文件到minio成功,bucket:&#123;&#125;,objectName:&#123;&#125;,错误信息:&#123;&#125;&quot;</span>,bucket,objectName);  </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line"> &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">  e.printStackTrace();  </span><br><span class="line">  log.error(<span class="string">&quot;上传文件出错,bucket:&#123;&#125;,objectName:&#123;&#125;,错误信息:&#123;&#125;&quot;</span>,bucket,objectName,e.getMessage());  </span><br><span class="line"> &#125;  </span><br><span class="line"> <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="test1-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取文件默认存储目录路径 年/月/日  </span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getDefaultFolderPath</span><span class="params">()</span> &#123;  </span><br><span class="line"> <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);  </span><br><span class="line"> <span class="type">String</span> <span class="variable">folder</span> <span class="operator">=</span> sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()).replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;/&quot;</span>)+<span class="string">&quot;/&quot;</span>;  </span><br><span class="line"> <span class="keyword">return</span> folder;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="test1-5"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取文件的md5  </span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getFileMd5</span><span class="params">(File file)</span> &#123;  </span><br><span class="line"> <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;  </span><br><span class="line">  <span class="type">String</span> <span class="variable">fileMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream);  </span><br><span class="line">  <span class="keyword">return</span> fileMd5;  </span><br><span class="line"> &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">  e.printStackTrace();  </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="test1-6"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 将文件信息添加到文件表  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId  机构id  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件md5值  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto  上传文件的信息  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket  桶  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名称  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.media.model.po.MediaFiles  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M * <span class="doctag">@date</span> 2022/10/12 21:22 */</span><span class="meta">@Transactional</span>  </span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName)</span>&#123;  </span><br><span class="line"> <span class="comment">//将文件信息保存到数据库  </span></span><br><span class="line"> <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);  </span><br><span class="line"> <span class="keyword">if</span>(mediaFiles == <span class="literal">null</span>)&#123;  </span><br><span class="line">  mediaFiles = <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();  </span><br><span class="line">  BeanUtils.copyProperties(uploadFileParamsDto,mediaFiles);  </span><br><span class="line">  <span class="comment">//文件id  </span></span><br><span class="line">  mediaFiles.setId(fileMd5);  </span><br><span class="line">  <span class="comment">//机构id  </span></span><br><span class="line">  mediaFiles.setCompanyId(companyId);  </span><br><span class="line">  <span class="comment">//桶  </span></span><br><span class="line">  mediaFiles.setBucket(bucket);  </span><br><span class="line">  <span class="comment">//file_path  </span></span><br><span class="line">  mediaFiles.setFilePath(objectName);  </span><br><span class="line">  <span class="comment">//file_id  </span></span><br><span class="line">  mediaFiles.setFileId(fileMd5);  </span><br><span class="line">  <span class="comment">//url  </span></span><br><span class="line">  mediaFiles.setUrl(<span class="string">&quot;/&quot;</span>+bucket+<span class="string">&quot;/&quot;</span>+objectName);  </span><br><span class="line">  <span class="comment">//上传时间  </span></span><br><span class="line">  mediaFiles.setCreateDate(LocalDateTime.now());  </span><br><span class="line">  <span class="comment">//状态  </span></span><br><span class="line">  mediaFiles.setStatus(<span class="string">&quot;1&quot;</span>);  </span><br><span class="line">  <span class="comment">//审核状态  </span></span><br><span class="line">  mediaFiles.setAuditStatus(<span class="string">&quot;002003&quot;</span>);  </span><br><span class="line">  <span class="comment">//插入数据库  </span></span><br><span class="line">  <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> mediaFilesMapper.insert(mediaFiles);  </span><br><span class="line">  <span class="keyword">if</span>(insert&lt;=<span class="number">0</span>)&#123;  </span><br><span class="line">   log.debug(<span class="string">&quot;向数据库保存文件失败,bucket:&#123;&#125;,objectName:&#123;&#125;&quot;</span>,bucket,objectName);  </span><br><span class="line">   <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="keyword">return</span> mediaFiles;  </span><br><span class="line">  </span><br><span class="line"> &#125;  </span><br><span class="line"> <span class="keyword">return</span> mediaFiles;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>
</li>
<li><p>完善controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;上传图片&quot;)</span>  </span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/upload/coursefile&quot;,consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span>  </span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile filedata,  </span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam(value = &quot;folder&quot;,required=false)</span> String folder,  </span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam(value = &quot;objectName&quot;,required=false)</span> String objectName)</span>  </span><br><span class="line">        <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//准备上传文件的信息  </span></span><br><span class="line">    <span class="type">UploadFileParamsDto</span> <span class="variable">uploadFileParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileParamsDto</span>();  </span><br><span class="line">    <span class="comment">//原始文件名称  </span></span><br><span class="line">    uploadFileParamsDto.setFilename(filedata.getOriginalFilename());  </span><br><span class="line">    <span class="comment">//文件大小  </span></span><br><span class="line">    uploadFileParamsDto.setFileSize(filedata.getSize());  </span><br><span class="line">    <span class="comment">//文件类型  </span></span><br><span class="line">    uploadFileParamsDto.setFileType(<span class="string">&quot;001001&quot;</span>);  </span><br><span class="line">    <span class="comment">//创建一个临时文件  </span></span><br><span class="line">    <span class="type">File</span> <span class="variable">tempFile</span> <span class="operator">=</span> File.createTempFile(<span class="string">&quot;minio&quot;</span>, <span class="string">&quot;.temp&quot;</span>);  </span><br><span class="line">    filedata.transferTo(tempFile);  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;  </span><br><span class="line">    <span class="comment">//文件路径  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">localFilePath</span> <span class="operator">=</span> tempFile.getAbsolutePath();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//调用service上传图片  </span></span><br><span class="line">    <span class="type">UploadFileResultDto</span> <span class="variable">uploadFileResultDto</span> <span class="operator">=</span> mediaFileService.uploadFile(companyId, uploadFileParamsDto, localFilePath);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> uploadFileResultDto;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-5测试"><a href="#4-5测试" class="headerlink" title="4.5测试"></a>4.5测试</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">### 上传文件  </span><br><span class="line">POST &#123;&#123;media_host&#125;&#125;/media/upload/coursefile  </span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=WebAppBoundary  </span><br><span class="line"></span><br><span class="line">--WebAppBoundary  </span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;filedata&quot;; filename=&quot;1.jpg&quot;  </span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/octet-stream  </span><br><span class="line">  </span><br><span class="line">&lt; d:/6.jpg</span><br></pre></td></tr></table></figure>
<h1 id="5-上传视频"><a href="#5-上传视频" class="headerlink" title="5.上传视频"></a>5.上传视频</h1><h2 id="5-1需求分析"><a href="#5-1需求分析" class="headerlink" title="5.1需求分析"></a>5.1需求分析</h2><p><img src="https://pic.imgdb.cn/item/66474878d9c307b7e9582c93.png" alt="code"></p>
<h2 id="5-2断点续传"><a href="#5-2断点续传" class="headerlink" title="5.2断点续传"></a>5.2断点续传</h2></li>
<li>断点续传指的是在<span class='p red'>下载或上传</span>时，将下载或上传任务（一个文件或一个压缩包）<span class='p red'>人为的划分为几个部分</span>，每一个部分<span class='p red'>采用一个线程进行上传或下载</span>，如果碰到网络故障，可以从已经上传或下载的部分开始<span class='p red'>继续上传下载未完成的部分</span>，而没有必要从头开始上传下载，断点续传可以提高节省操作时间，提高用户体验性。<br><img src="https://pic.imgdb.cn/item/66474936d9c307b7e95912bb.png" alt="code"><br><img src="https://pic.imgdb.cn/item/66474953d9c307b7e95934ea.png" alt="code"></li>
</ul>
<ol>
<li>前端对文件进行分块。</li>
<li>前端上传分块文件前请求媒资服务检查文件是否存在，如果已经存在则不再上传。s</li>
<li>如果分块文件不存在则前端开始上传</li>
<li>前端请求媒资服务上传分块。</li>
<li>媒资服务将分块上传至MinIO。</li>
<li>前端将分块上传完毕请求媒资服务合并分块。</li>
<li>媒资服务判断分块上传完成则请求MinIO合并文件。</li>
<li>合并完成校验合并后的文件是否完整，如果不完整则删除文件。<h2 id="5-3接口定义"><a href="#5-3接口定义" class="headerlink" title="5.3接口定义"></a>5.3接口定义</h2></li>
</ol>
<ul>
<li>与前端的约定是操作成功返回{code:0}否则返回{code:-1}</li>
<li>在base工程下的model包下定义通用返回的类型RestResponse<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.model;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">//@description 通用结果类型</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestResponse</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//响应编码,0为正常,-1错误</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="comment">//响应提示信息</span></span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="comment">//响应内容</span></span><br><span class="line">    <span class="keyword">private</span> T result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RestResponse</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="number">0</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RestResponse</span><span class="params">(<span class="type">int</span> code, String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//错误信息的封装</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestResponse&lt;T&gt; <span class="title function_">validfail</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        RestResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RestResponse</span>&lt;T&gt;();</span><br><span class="line">        response.setCode(-<span class="number">1</span>);</span><br><span class="line">        response.setMsg(msg);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestResponse&lt;T&gt; <span class="title function_">validfail</span><span class="params">(T result,String msg)</span> &#123;</span><br><span class="line">        RestResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RestResponse</span>&lt;T&gt;();</span><br><span class="line">        response.setCode(-<span class="number">1</span>);</span><br><span class="line">        response.setResult(result);</span><br><span class="line">        response.setMsg(msg);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加正常响应数据（包含响应内容）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestResponse&lt;T&gt; <span class="title function_">success</span><span class="params">(T result)</span> &#123;</span><br><span class="line">        RestResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RestResponse</span>&lt;T&gt;();</span><br><span class="line">        response.setResult(result);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestResponse&lt;T&gt; <span class="title function_">success</span><span class="params">(T result,String msg)</span> &#123;</span><br><span class="line">        RestResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RestResponse</span>&lt;T&gt;();</span><br><span class="line">        response.setResult(result);</span><br><span class="line">        response.setMsg(msg);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加正常响应数据（不包含响应内容）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestResponse&lt;T&gt; <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestResponse</span>&lt;T&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">isSuccessful</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.code == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>创建BigFilesController<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;大文件上传接口&quot;, tags = &quot;大文件上传接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BigFilesController</span> &#123;</span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;文件上传前检查文件&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/checkfile&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;分块文件上传前检查分块&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5, <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;上传分块文件&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file, <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5, <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;合并分块文件&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/mergechunks&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">mergeChunks</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5, <span class="meta">@RequestParam(&quot;fileName&quot;)</span> String fileName, <span class="meta">@RequestParam(&quot;chunkTotal&quot;)</span> <span class="type">int</span> chunkTotal)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-4接口定义"><a href="#5-4接口定义" class="headerlink" title="5.4接口定义"></a>5.4接口定义</h2><h3 id="5-4-1检查文件和分块"><a href="#5-4-1检查文件和分块" class="headerlink" title="5.4.1检查文件和分块"></a>5.4.1检查文件和分块</h3></li>
<li>定义MediaFileService接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查文件是否存在</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5 文件的md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查分块是否存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5       文件的MD5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkIndex    分块序号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">checkChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunkIndex)</span>;</span><br></pre></td></tr></table></figure></li>
<li>判断文件是否存在<ul>
<li>首先判断数据库中是否存在该文件</li>
<li>其次判断minio的bucket中是否存在该文件<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span> &#123;</span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">    <span class="comment">// 数据库中不存在，则直接返回false 表示不存在</span></span><br><span class="line">    <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 若数据库中存在，根据数据库中的文件信息，则继续判断bucket中是否存在</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioClient.getObject(GetObjectArgs</span><br><span class="line">                .builder()</span><br><span class="line">                .bucket(mediaFiles.getBucket())</span><br><span class="line">                .object(mediaFiles.getFilePath())</span><br><span class="line">                .build());</span><br><span class="line">        <span class="keyword">if</span> (inputStream == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>判断分块是否存在<ul>
<li>分块是否存在，只需要判断minio对应的目录下是否存在分块文件<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunkIndex)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取分块目录</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> chunkFileFolderPath + chunkIndex;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 判断分块是否存在</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioClient.getObject(GetObjectArgs</span><br><span class="line">                .builder()</span><br><span class="line">                .bucket(video_files)</span><br><span class="line">                .object(chunkFilePath)</span><br><span class="line">                .build());</span><br><span class="line">        <span class="comment">// 不存在返回false</span></span><br><span class="line">        <span class="keyword">if</span> (inputStream == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// 出异常也返回false</span></span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 否则返回true</span></span><br><span class="line">    <span class="keyword">return</span> RestResponse.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getChunkFileFolderPath</span><span class="params">(String fileMd5)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fileMd5.substring(<span class="number">0</span>, <span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>, <span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;chunk&quot;</span> + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-4-2上传分块"><a href="#5-4-2上传分块" class="headerlink" title="5.4.2上传分块"></a>5.4.2上传分块</h3></li>
</ul>
</li>
<li>定义接口<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传分块</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5   文件MD5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunk     分块序号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bytes     文件字节</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">RestResponse <span class="title function_">uploadChunk</span><span class="params">(String fileMd5,<span class="type">int</span> chunk,<span class="type">byte</span>[] bytes)</span>;</span><br></pre></td></tr></table></figure></li>
<li>接口实现<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunk, <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">    <span class="comment">// 分块文件路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5) + chunk;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        addMediaFilesToMinIO(bytes, video_files, chunkFilePath);</span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;上传分块文件：&#123;&#125;失败：&#123;&#125;&quot;</span>, chunkFilePath, e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> RestResponse.validfail(<span class="string">&quot;上传文件失败&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-4-3上传分块测试"><a href="#5-4-3上传分块测试" class="headerlink" title="5.4.3上传分块测试"></a>5.4.3上传分块测试</h3></li>
<li>完善controller<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;文件上传前检查文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/checkfile&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.checkFile(fileMd5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;分块文件上传前检查分块&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5, <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.checkChunk(fileMd5, chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;上传分块文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file, <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5, <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.uploadChunk(fileMd5, chunk, file.getBytes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Lemon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/05/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-%E8%9E%8D%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/">http://example.com/2024/05/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-%E8%9E%8D%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Lemon的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://images.wallpaperscraft.com/image/single/girl_street_sakura_1156520_1280x720.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/05/19/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E-%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80%E5%92%8C%E9%A1%B9%E7%9B%AE%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="谷粒商城--分布式基础和项目环境搭建"><img class="cover" src="https://images.wallpaperscraft.com/image/single/girl_kimono_flowers_1217665_1280x720.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">谷粒商城--分布式基础和项目环境搭建</div></div></a></div><div class="next-post pull-right"><a href="/2024/05/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/" title="学成在线--内容管理模块"><img class="cover" src="https://images.wallpaperscraft.com/image/single/girl_street_sakura_1156520_1280x720.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">学成在线--内容管理模块</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E6%A8%A1%E5%9D%97%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">1.模块需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.1模块介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">1.2业务流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">1.3数据模型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E6%90%AD%E5%BB%BA%E6%A8%A1%E5%9D%97%E7%8E%AF%E5%A2%83"><span class="toc-text">2.搭建模块环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1%E6%9E%84%E5%BB%BA%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">2.1构建问题分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2%E6%90%AD%E5%BB%BANacos"><span class="toc-text">2.2搭建Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%AD%E5%BF%83"><span class="toc-text">2.2.1服务发现中心</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-text">2.2.2配置中心</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3%E6%90%AD%E5%BB%BA%E7%BD%91%E5%85%B3"><span class="toc-text">2.3搭建网关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4%E6%90%AD%E5%BB%BA%E5%AA%92%E8%B5%84%E5%B7%A5%E7%A8%8B"><span class="toc-text">2.4搭建媒资工程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">3.分布式文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1%E4%BB%8B%E7%BB%8D"><span class="toc-text">3.1介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2minio%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">3.2minio文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1%E4%BB%8B%E7%BB%8D"><span class="toc-text">3.2.1介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2window%E4%BD%BF%E7%94%A8"><span class="toc-text">3.2.2window使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3%E6%9C%AC%E5%9C%B0%E6%B5%8B%E8%AF%95%E6%96%87%E4%BB%B6%E5%92%8C%E8%A7%86%E9%A2%91%E6%96%B9%E6%B3%95"><span class="toc-text">3.2.3本地测试文件和视频方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-1minio%E4%B8%8A%E4%BC%A0-%E5%88%A0%E9%99%A4-%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="toc-text">3.2.3.1minio上传&#x2F;删除&#x2F;下载文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-2%E6%9C%AC%E5%9C%B0%E6%8B%86%E5%88%86-%E5%90%88%E5%B9%B6%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%B9%E6%B3%95"><span class="toc-text">3.2.3.2本地拆分&#x2F;合并大文件方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-3minio%E6%8B%86%E5%88%86%E5%90%88%E5%B9%B6%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%B9%E6%B3%95"><span class="toc-text">3.2.3.3minio拆分合并大文件方法</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="toc-text">4.上传文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">4.1需求分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-text">4.2准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">4.3接口定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-text">4.4接口实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5%E6%B5%8B%E8%AF%95"><span class="toc-text">4.5测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E4%B8%8A%E4%BC%A0%E8%A7%86%E9%A2%91"><span class="toc-text">5.上传视频</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">5.1需求分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0"><span class="toc-text">5.2断点续传</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">5.3接口定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">5.4接口定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-1%E6%A3%80%E6%9F%A5%E6%96%87%E4%BB%B6%E5%92%8C%E5%88%86%E5%9D%97"><span class="toc-text">5.4.1检查文件和分块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-2%E4%B8%8A%E4%BC%A0%E5%88%86%E5%9D%97"><span class="toc-text">5.4.2上传分块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-3%E4%B8%8A%E4%BC%A0%E5%88%86%E5%9D%97%E6%B5%8B%E8%AF%95"><span class="toc-text">5.4.3上传分块测试</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Lemon</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><script defer src="/js/light.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/cursor.js"></script><script async src="/js/title.js"></script><script defer src="/js/fomal.js"></script><canvas id="snow"></canvas><script async src="/js/snow.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
    function butterfly_categories_card_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<style>li.categoryBar-list-item{width:32.3%;}.categoryBar-list{max-height: 190px;overflow:auto;}.categoryBar-list::-webkit-scrollbar{width:0!important}@media screen and (max-width: 650px){.categoryBar-list{max-height: 160px;}}</style><div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(https://source.fomal.cc/img/home_bg.webp);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/SpringCloud/&quot;);" href="javascript:void(0);">SpringCloud</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr">Ubuntu指南</span></li><li class="categoryBar-list-item" style="background:url(https://source.fomal.cc/img/home_bg.webp);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/天机学堂/&quot;);" href="javascript:void(0);">天机学堂</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr">玩转Win10</span></li><li class="categoryBar-list-item" style="background:url(https://source.fomal.cc/img/home_bg.webp);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/今日指数金融/&quot;);" href="javascript:void(0);">今日指数金融</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr">长篇小说连载</span></li><li class="categoryBar-list-item" style="background:url(https://assets.akilar.top/image/cover4.webp);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/学成在线/&quot;);" href="javascript:void(0);">学成在线</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr">个人日记</span></li><li class="categoryBar-list-item" style="background:url(https://assets.akilar.top/image/cover5.webp);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/权限管理系统/&quot;);" href="javascript:void(0);">权限管理系统</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr">诗词歌赋</span></li><li class="categoryBar-list-item" style="background:url(https://assets.akilar.top/image/cover6.webp);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/恒强/&quot;);" href="javascript:void(0);">恒强</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">杂谈教程</span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/谷粒商城/&quot;);" href="javascript:void(0);">谷粒商城</a><span class="categoryBar-list-count">5</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/探花交友/&quot;);" href="javascript:void(0);">探花交友</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/项目通用/&quot;);" href="javascript:void(0);">项目通用</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li></ul></div></div>';
      console.log('已挂载butterfly_categories_card')
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      }
    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    butterfly_categories_card_injector_config()
    }
  </script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v6.2.0" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v4.3.1" title=""><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" data-title="本站采用多线部署，主线路托管于Vercel" title=""><img src="https://img.shields.io/badge/Hosted-Vercel-brightgreen?style=flat&amp;logo=Vercel" alt=""/></a><a class="github-badge" target="_blank" href="https://dashboard.4everland.org/" style="margin-inline:5px" data-title="本站采用多线部署，备用线路托管于4EVERLAND" title=""><img src="https://img.shields.io/badge/Hosted-4EVERLAND-22DDDD?style=flat&amp;logo=IPFS" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2024/06/05/权限管理系统-用户管理/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://images.wallpaperscraft.com/image/single/girl_dress_stars_1221251_1280x720.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-06-05</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2024/06/05/权限管理系统-用户管理/&quot;);" href="javascript:void(0);" alt="">用户管理</a><div class="blog-slider__text">权限管理系统--用户管理</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2024/06/05/权限管理系统-用户管理/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2024/06/03/权限管理系统-角色管理前端/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://images.wallpaperscraft.com/image/single/girl_street_sakura_1156520_1280x720.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-06-03</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2024/06/03/权限管理系统-角色管理前端/&quot;);" href="javascript:void(0);" alt="">角色管理前端</a><div class="blog-slider__text">权限管理系统--角色管理前端</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2024/06/03/权限管理系统-角色管理前端/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '1s');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '2');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>